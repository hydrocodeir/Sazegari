{% extends "base.html" %}
{% block head_extra %}
  <link rel="stylesheet" href="/static/css/ckeditor5_rtl.css" />
{% endblock %}
{% block page_title %}گزارش #{{ report.id }}{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-12">
    <div class="card p-3 report-hero hover-lift border-0">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
        <div class="flex-grow-1">
          {% if can_edit %}
            <div class="row g-2">
              <div class="col-lg-7">
                <label class="form-label small text-muted mb-1">عنوان گزارش (اختیاری)</label>
                <input id="metaTitle" class="form-control" placeholder="مثلاً: گزارش جامع استانی سازگاری با کم‌آبی" value="{{ doc.meta.title }}">
              </div>
              <div class="col-lg-5">
                <label class="form-label small text-muted mb-1">زیرعنوان (اختیاری)</label>
                <input id="metaSubtitle" class="form-control" placeholder="مثلاً: سال ۱۴۰۴ / ارگان ..." value="{{ doc.meta.subtitle }}">
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
              <button class="btn btn-sm btn-outline-primary" type="button" onclick="saveMeta()">
                <i class="bi bi-check2-circle me-1"></i>
                ذخیره عنوان
              </button>
              <span id="metaSaveState" class="text-muted small">&nbsp;</span>
            </div>
          {% else %}
            <div class="h5 m-0">{{ doc.meta.title or ("گزارش #" ~ report.id) }}</div>
            {% if doc.meta.subtitle %}<div class="text-muted small mt-1">تیپ فرم پایش و حوزه خروجی را انتخاب کن تا جدول تجمیعی (براساس آخرین بازه ثبت‌شده) به گزارش اضافه شود.</div>{% endif %}
          {% endif %}

          <div class="text-muted small mt-2">
            نوع: <span class="badge text-bg-info">{{ report.kind_label }}</span>
            <span class="mx-1">|</span>
            وضعیت: <span class="badge" id="statusBadge">{{ report.status_label }}</span>
            {% if report.current_owner_id %}<span class="mx-1">|</span> در صف: <span class="badge text-bg-warning">{{ owner_name }}</span>{% endif %}
          </div>

          <div class="report-stepper mt-3" id="reportStepper">
            <div class="report-step" data-step="meta"><i class="bi bi-ui-checks"></i> عنوان</div>
            <div class="report-step" data-step="intro"><i class="bi bi-card-text"></i> مقدمه</div>
            <div class="report-step" data-step="sections"><i class="bi bi-table"></i> فرم‌ها</div>
            <div class="report-step" data-step="conclusion"><i class="bi bi-flag"></i> نتیجه‌گیری</div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
          <a class="btn btn-outline-secondary btn-sm" href="/reports"><i class="bi bi-arrow-right me-1"></i>بازگشت</a>
          <a class="btn btn-outline-primary btn-sm" href="/reports/{{ report.id }}/pdf"><i class="bi bi-file-earmark-pdf me-1"></i>دانلود PDF</a>
          {% if can_edit %}
            <button class="btn btn-primary btn-sm" type="button" onclick="saveAll()"><i class="bi bi-cloud-check me-1"></i>ذخیره همه</button>
          {% endif %}
          {% if user.role.value in ['org_county_expert','org_prov_expert'] and report.current_owner_id == user.id and report.status.value != 'final_approved' %}
            <form method="post" action="/reports/{{ report.id }}/delete" onsubmit="return confirm('این گزارش حذف می‌شود. ادامه می‌دهید؟')" class="m-0">
              <button class="btn btn-outline-danger btn-sm" type="submit"><i class="bi bi-trash me-1"></i>حذف</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Left: Builder / Full report -->
  <div class="col-lg-8">

    <!-- 1) Intro -->
    <div class="card p-3 border-0 shadow-sm mb-3 hover-lift">
      <div class="d-flex justify-content-between align-items-start gap-2">
        <div>
          <div class="h6 m-0">۱) مقدمه و پیوست‌ها</div>
          <div class="text-muted small mt-1">این متن در ابتدای گزارش PDF قرار می‌گیرد؛ فایل‌ها در بخش «پیوست‌های گزارش» ذخیره و نمایش داده می‌شوند.</div>
        </div>
        {% if can_edit %}
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" type="button" onclick="saveIntro({silent:false})">ذخیره</button>
          </div>
        {% endif %}
      </div>

      {% if can_edit %}
        <div class="editor-shell mt-3">
          <div class="editor-meta">
            <div class="d-flex gap-2 align-items-center">
              <span class="fw-semibold">متن ابتدایی</span>
              <span class="muted" id="introWordCount"></span>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span class="muted" id="introSaveState">&nbsp;</span>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-secondary" type="button" onclick="insertTemplate('intro','standard')">قالب استاندارد</button>
                <button class="btn btn-outline-secondary" type="button" onclick="insertTemplate('intro','minimal')">قالب کوتاه</button>
              </div>
            </div>
          </div>
          <textarea id="introEditor" class="rte-textarea">{{ doc.intro_html | e }}</textarea>
        </div>

        <div class="dropzone mt-3" id="reportDropzone" tabindex="0">
          <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-cloud-arrow-up fs-4"></i>
              <div>
                <div class="fw-semibold">آپلود فایل</div>
                <div class="text-muted small">فایل را اینجا رها کن یا انتخاب کن. پس از آپلود، در بخش «پیوست‌های گزارش» نمایش داده می‌شود.</div>
              </div>
            </div>
            <div class="ms-md-auto d-flex flex-column align-items-end gap-1">
              <div class="d-flex gap-2 align-items-center">
                <input class="d-none" type="file" id="reportFile" />
                <button class="btn btn-sm btn-outline-secondary" id="pickUploadBtn" type="button" onclick="event.stopPropagation(); pickUploadFile();">انتخاب فایل</button>
                <button class="btn btn-sm btn-outline-primary" id="uploadBtn" type="button" onclick="event.stopPropagation(); uploadSelectedFile();">
                  <span id="uploadBtnText">آپلود</span>
                  <span id="uploadSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                </button>
              </div>
              <div id="reportFileSelectedInfo" class="small text-muted">هیچ فایلی انتخاب نشده است.</div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="mt-2">{{ doc.intro_html | safe }}</div>
      {% endif %}
    </div>

    <!-- Attachments -->
    <div class="card p-3 border-0 shadow-sm mb-3 hover-lift" id="fileAttachmentsBox">
      {% include "reports/_attachments_files.html" %}
    </div>

    <!-- 2) Sections -->
    <div class="card p-3 border-0 shadow-sm mb-3 hover-lift">
      <div class="d-flex justify-content-between align-items-start gap-2">
        <div>
          <div class="h6 m-0">۲) فرم‌های انتخابی و جداول</div>
          {% if can_edit %}
            <div class="text-muted small mt-1">فرم و ثبت را انتخاب کن، به گزارش اضافه کن و (در صورت نیاز) توضیح بنویس. می‌توانی ترتیب فرم‌ها را با Drag & Drop تغییر بدهی.</div>
          {% endif %}
        </div>
        {% if can_edit %}
          <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleAllSections()"><i class="bi bi-arrows-collapse me-1"></i>جمع/باز</button>
        {% endif %}
      </div>

      {% if can_edit %}
        <hr>
        {% if available_forms|length == 0 %}
          <div class="alert alert-warning py-2 small mb-0">هنوز هیچ «ثبت داده‌ای» برای این واحد وجود ندارد. ابتدا فرم‌ها را تکمیل کنید، سپس آن‌ها را به گزارش اضافه کنید.</div>
        {% else %}
        <form hx-post="/reports/{{ report.id }}/sections/add" hx-target="#sectionsBox" hx-swap="innerHTML" class="row g-2 align-items-end">
          <div class="col-md-4">
            <label class="form-label small text-muted">۱) انتخاب فرم</label>
            <select name="form_id" class="form-select form-select-sm"
                    hx-get="/reports/{{ report.id }}/sections/submission-options"
                    hx-trigger="load, change"
                    hx-target="#submissionSelect"
                    hx-swap="innerHTML">
              {% for f in available_forms %}
                <option value="{{ f.id }}">{{ f.title }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-5">
            <label class="form-label small text-muted">۲) انتخاب ثبت</label>
            <select id="submissionSelect" name="submission_id" class="form-select form-select-sm" required>
              <option value="">ابتدا فرم را انتخاب کنید…</option>
            </select>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary btn-sm w-100">افزودن به گزارش</button>
          </div>
        </form>
        {% endif %}

        <hr class="my-3">
        {% if program_types and program_types|length > 0 %}
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-semibold">پایش برنامه (گزارش مقایسه‌ای)</div>
              <div class="text-muted small mt-1">تیپ فرم پایش و حوزه خروجی را انتخاب کن تا جدول تجمیعی (براساس آخرین بازه ثبت‌شده) به گزارش اضافه شود.</div>
            </div>
          </div>

          <form hx-post="/reports/{{ report.id }}/program_sections/add" hx-target="#sectionsBox" hx-swap="innerHTML" class="row g-2 align-items-end mt-1">
            <div class="col-md-6">
              <label class="form-label small text-muted">تیپ فرم پایش</label>
              <select name="form_type_id" class="form-select form-select-sm" required>
                <option value="">-- انتخاب --</option>
                {% for t in program_types %}
                  <option value="{{ t.id }}">{{ t.title }}</option>
                {% endfor %}
              </select>
              <div class="form-text small">جدول بر اساس <span class="fw-semibold">آخرین بازه ثبت‌شده</span> برای همین تیپ‌فرم و حوزه خروجی تولید می‌شود.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label small text-muted">حوزه خروجی</label>
              {% if report.kind.value == 'county' %}
                <input type="hidden" name="mode" value="county">
                <div class="form-control form-control-sm bg-body-tertiary">شهرستان (همین گزارش)</div>
              {% else %}
                <select name="mode" class="form-select form-select-sm" required>
                  <option value="province">استان (ثبت‌های استانی)</option>
                  <option value="county_agg">تجمیع شهرستان‌ها</option>
                </select>
              {% endif %}
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-outline-primary btn-sm w-100"><i class="bi bi-plus-circle me-1"></i>افزودن خروجی</button>
            </div>
          </form>
        {% else %}
          <div class="alert alert-info py-2 small mb-0">برای این سازمان هنوز «تیپ فرم پایش برنامه» همراه با برنامه پایش توسط دبیرخانه آماده نشده است.</div>
        {% endif %}
      {% endif %}

      <div class="mt-3" id="sectionsBox">
        {% include "reports/_sections.html" %}
      </div>
    </div>

    <!-- 3) Conclusion -->
    <div class="card p-3 border-0 shadow-sm hover-lift">
      <div class="d-flex justify-content-between align-items-start gap-2">
        <div>
          <div class="h6 m-0">۳) نتیجه‌گیری و نتایج</div>
          <div class="text-muted small mt-1">خلاصه‌ی برداشت‌ها، پیشنهادها، و نکات نهایی را اینجا اضافه کن.</div>
        </div>
        {% if can_edit %}
          <button class="btn btn-sm btn-outline-primary" type="button" onclick="saveConclusion({silent:false})">ذخیره</button>
        {% endif %}
      </div>

      {% if can_edit %}
        <div class="editor-shell mt-3">
          <div class="editor-meta">
            <div class="d-flex gap-2 align-items-center">
              <span class="fw-semibold">متن نتیجه‌گیری</span>
              <span class="muted" id="conclusionWordCount"></span>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span class="muted" id="conclusionSaveState">&nbsp;</span>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-secondary" type="button" onclick="insertTemplate('conclusion','standard')">قالب استاندارد</button>
                <button class="btn btn-outline-secondary" type="button" onclick="insertTemplate('conclusion','minimal')">قالب کوتاه</button>
              </div>
            </div>
          </div>
          <textarea id="conclusionEditor" class="rte-textarea">{{ doc.conclusion_html | e }}</textarea>
        </div>
      {% else %}
        <div class="mt-2">{{ doc.conclusion_html | safe }}</div>
      {% endif %}
    </div>
  </div>

  <!-- Right: Workflow/History -->
  <div class="col-lg-4">
    <div class="card p-3 border-0 shadow-sm mb-3 hover-lift" id="actionsBox">
      {% include "reports/_actions.html" %}
    </div>

    <div class="card p-3 border-0 shadow-sm hover-lift">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="m-0">تاریخچه گردش‌کار</h6>
        <button
          class="btn btn-sm btn-outline-primary"
          type="button"
          data-bs-toggle="modal"
          data-bs-target="#workflowFlowModal"
          onclick="openWorkflowFlowModal()">
          <i class="bi bi-diagram-3 me-1"></i>نمایش فلوچارت
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle" data-paginate="true" data-page-size="5">
          <thead><tr><th>#</th><th>اقدام</th><th>از</th><th>به</th><th>انجام‌دهنده</th></tr></thead>
          <tbody>
            {% for l in logs %}
              <tr>
                <td>{{ l.id }}</td>
                <td>{{ l.action }}</td>
                <td>{{ l.from_status }}</td>
                <td>{{ l.to_status }}</td>
                <td>{{ actor_map.get(l.actor_id, l.actor_id) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="workflowFlowModal" tabindex="-1" aria-labelledby="workflowFlowModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="workflowFlowModalLabel">فلوچارت گردش‌کار گزارش</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="workflowFlowDiagram" class="border rounded-3 bg-light-subtle" style="height: 62vh; min-height: 420px;"></div>
            <div id="workflowFlowHint" class="text-muted small mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card p-3 border-0 shadow-sm mt-3 hover-lift">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="m-0">لاگ تغییرات محتوا</h6>
        <div class="text-muted small">(ReportAuditLog)</div>
      </div>

      {% if audit_logs|length == 0 %}
        <div class="text-muted small">تا الان تغییری ثبت نشده است.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle" data-paginate="true" data-page-size="5">
            <thead>
              <tr>
                <th>#</th>
                <th>اقدام</th>
                <th>فیلد</th>
                <th>کاربر</th>
              </tr>
            </thead>
            <tbody>
              {% for a in audit_logs %}
                <tr>
                  <td>{{ a.id }}</td>
                  <td><span class="badge text-bg-light">{{ a.action }}</span></td>
                  <td>{{ a.field }}</td>
                  <td>{{ actor_map.get(a.actor_id, a.actor_id) }}</td>
                </tr>
                {% if a.comment or a.before_json or a.after_json %}
                <tr>
                  <td colspan="4" class="bg-body-tertiary">
                    <details>
                      <summary class="small text-muted">جزئیات</summary>
                      {% if a.comment %}
                        <div class="small mt-2"><span class="text-muted">توضیح:</span> {{ a.comment }}</div>
                      {% endif %}
                      {% if a.before_json %}
                        <div class="small mt-2">
                          <div class="text-muted">قبل:</div>
                          <pre class="small mb-0" style="white-space: pre-wrap">{{ a.before_json }}</pre>
                        </div>
                      {% endif %}
                      {% if a.after_json %}
                        <div class="small mt-2">
                          <div class="text-muted">بعد:</div>
                          <pre class="small mb-0" style="white-space: pre-wrap">{{ a.after_json }}</pre>
                        </div>
                      {% endif %}
                    </details>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<script
  src="{{ url_for('static', path='/js/ckeditor5-build-classic/ckeditor.js') }}"
  onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/@ckeditor/ckeditor5-build-classic@44.3.0/build/ckeditor.js';">
</script>
<script
  src="{{ url_for('static', path='/js/ckeditor5-build-classic/fa.js') }}"
  onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/@ckeditor/ckeditor5-build-classic@44.3.0/build/translations/fa.js';">
</script>
<script src="{{ url_for('static', path='/js/gojs_3.1.5.js') }}"></script>
<script src="{{ url_for('static', path='/js/Sortable.min.js') }}"></script>

<script>
let rteIntro = null;
let rteConclusion = null;
let rteSections = {};
let rteProgramSections = {};
let sortable = null;
let sectionsCollapsed = false;

let dirtyIntro = false;
let dirtyConclusion = false;
let dirtyMeta = false;
let autoSaveTimers = {intro: null, conclusion: null, meta: null};
let workflowFlowDiagram = null;

const workflowLogs = [
  {% for l in logs %}
  {
    id: {{ l.id }},
    action: {{ (l.action|string)|tojson }},
    from_status: {{ (l.from_status|string)|tojson }},
    to_status: {{ (l.to_status|string)|tojson }},
    actor: {{ (actor_map.get(l.actor_id, l.actor_id)|string)|tojson }}
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

const FLOW_COLORS = [
  "#0d6efd", "#198754", "#dc3545", "#fd7e14", "#6f42c1",
  "#20c997", "#0dcaf0", "#6c757d", "#d63384", "#6610f2"
];

function normalizeStatusKey(raw){
  const s = String(raw || "").trim();
  return s || "unknown";
}

function prettifyStatus(raw){
  let s = String(raw || "").trim();
  if(!s) return "نامشخص";
  s = s.replace(/^ReportStatus\./, "");
  return s.replaceAll("_", " ");
}

function statusColor(statusKey){
  let hash = 0;
  const s = String(statusKey || "");
  for(let i = 0; i < s.length; i++) hash = (hash * 31 + s.charCodeAt(i)) >>> 0;
  return FLOW_COLORS[hash % FLOW_COLORS.length];
}

function trimText(txt, maxLen){
  const t = String(txt || "");
  if(t.length <= maxLen) return t;
  return t.slice(0, Math.max(0, maxLen - 1)) + "…";
}

function buildWorkflowFlowGraphData(logs){
  const sorted = [...(logs || [])].sort((a, b) => Number(a.id || 0) - Number(b.id || 0));
  const nodesMap = new Map();
  const linksMap = new Map();

  function ensureNode(statusRaw){
    const key = normalizeStatusKey(statusRaw);
    if(!nodesMap.has(key)){
      nodesMap.set(key, {
        key,
        label: prettifyStatus(statusRaw),
        color: statusColor(key),
        inCount: 0,
        outCount: 0
      });
    }
    return nodesMap.get(key);
  }

  for(const l of sorted){
    const fromNode = ensureNode(l.from_status || "unknown");
    const toNode = ensureNode(l.to_status || l.from_status || "unknown");
    fromNode.outCount += 1;
    toNode.inCount += 1;

    const lk = `${fromNode.key}=>${toNode.key}`;
    if(!linksMap.has(lk)){
      linksMap.set(lk, {
        from: fromNode.key,
        to: toNode.key,
        count: 0,
        lastAction: "",
        actors: new Set()
      });
    }
    const edge = linksMap.get(lk);
    edge.count += 1;
    if(l.action) edge.lastAction = String(l.action);
    if(l.actor) edge.actors.add(String(l.actor));
  }

  const nodeData = Array.from(nodesMap.values()).map((n) => ({
    key: n.key,
    label: n.label,
    color: n.color,
    meta: `ورودی: ${n.inCount} | خروجی: ${n.outCount}`
  }));

  const linkData = Array.from(linksMap.values()).map((l) => {
    const actorLine = trimText(Array.from(l.actors).join("، "), 48);
    return {
      from: l.from,
      to: l.to,
      text: l.lastAction ? prettifyStatus(l.lastAction) : "transition",
      subtext: actorLine ? `${l.count} بار | ${actorLine}` : `${l.count} بار`
    };
  });

  if(nodeData.length === 0){
    const fallback = prettifyStatus('{{ report.status.value }}');
    nodeData.push({
      key: "current_status",
      label: fallback,
      color: statusColor("current_status"),
      meta: "هنوز سابقه‌ای ثبت نشده است"
    });
  }

  return { nodeData, linkData };
}

function renderWorkflowFlowDiagram(){
  const host = document.getElementById("workflowFlowDiagram");
  const hint = document.getElementById("workflowFlowHint");
  if(!host) return;

  if(!window.go){
    if(hint) hint.textContent = "کتابخانه GoJS بارگذاری نشد.";
    return;
  }

  const $ = go.GraphObject.make;

  if(!workflowFlowDiagram){
    workflowFlowDiagram = $(go.Diagram, "workflowFlowDiagram", {
      isReadOnly: true,
      "undoManager.isEnabled": false,
      "animationManager.isEnabled": true,
      contentAlignment: go.Spot.Center,
      padding: 20,
      initialAutoScale: go.Diagram.Uniform,
      "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
      layout: $(go.LayeredDigraphLayout, {
        direction: 0,
        layerSpacing: 70,
        columnSpacing: 40,
        setsPortSpots: false
      })
    });

    workflowFlowDiagram.nodeTemplate =
      $(go.Node, "Auto",
        { selectionAdorned: false },
        $(go.Shape, "RoundedRectangle",
          {
            strokeWidth: 0,
            parameter1: 12,
            shadowVisible: true,
            shadowColor: "rgba(15, 23, 42, 0.2)",
            shadowOffset: new go.Point(0, 2)
          },
          new go.Binding("fill", "color")
        ),
        $(go.Panel, "Vertical", { margin: 10, maxSize: new go.Size(280, NaN) },
          $(go.TextBlock,
            {
              stroke: "#fff",
              font: "700 12px Vazirmatn, Tahoma, Arial, sans-serif",
              textAlign: "center",
              wrap: go.WrapFit
            },
            new go.Binding("text", "label")
          ),
          $(go.TextBlock,
            {
              stroke: "rgba(255,255,255,.9)",
              margin: new go.Margin(4, 0, 0, 0),
              font: "11px Vazirmatn, Tahoma, Arial, sans-serif",
              textAlign: "center"
            },
            new go.Binding("text", "meta")
          )
        )
      );

    workflowFlowDiagram.linkTemplate =
      $(go.Link,
        {
          curve: go.Curve.Bezier,
          routing: go.Routing.AvoidsNodes,
          corner: 10,
          toShortLength: 6
        },
        $(go.Shape, { stroke: "#64748b", strokeWidth: 2 }),
        $(go.Shape, { toArrow: "Standard", fill: "#64748b", stroke: null }),
        $(go.Panel, "Auto",
          { segmentFraction: 0.5 },
          $(go.Shape, "RoundedRectangle", { fill: "rgba(255,255,255,.95)", stroke: "#dbe2ea" }),
          $(go.TextBlock,
            {
              margin: new go.Margin(4, 8, 3, 8),
              stroke: "#1f2937",
              font: "600 11px Vazirmatn, Tahoma, Arial, sans-serif",
              wrap: go.WrapFit
            },
            new go.Binding("text", "text")
          )
        ),
        $(go.Panel, "Auto",
          { segmentFraction: 0.5, segmentOffset: new go.Point(0, 18) },
          $(go.Shape, "RoundedRectangle", { fill: "rgba(248,250,252,.98)", stroke: "#e5e7eb" }),
          $(go.TextBlock,
            {
              margin: new go.Margin(2, 8, 4, 8),
              stroke: "#475569",
              font: "11px Vazirmatn, Tahoma, Arial, sans-serif",
              wrap: go.WrapFit
            },
            new go.Binding("text", "subtext")
          )
        )
      );
  }

  const graph = buildWorkflowFlowGraphData(workflowLogs);
  workflowFlowDiagram.model = new go.GraphLinksModel(graph.nodeData, graph.linkData);

  if(hint){
    hint.textContent = graph.linkData.length
      ? `تعداد وضعیت‌ها: ${graph.nodeData.length} | تعداد انتقال‌ها: ${graph.linkData.length}`
      : "برای این گزارش هنوز انتقال گردش‌کار ثبت نشده است.";
  }

  setTimeout(() => {
    try{
      workflowFlowDiagram.zoomToFit();
    }catch(e){}
  }, 80);
}

function openWorkflowFlowModal(){
  setTimeout(renderWorkflowFlowDiagram, 80);
}

function setStatusBadge(){
  const badge = document.getElementById('statusBadge');
  if(!badge) return;
  const v = '{{ report.status.value }}';
  let cls = 'text-bg-secondary';
  if(v === 'needs_revision') cls = 'text-bg-warning';
  if(v === 'final_approved') cls = 'text-bg-success';
  if(v.endsWith('_review')) cls = 'text-bg-info';
  badge.classList.add('badge', cls);
}

function htmlToText(html){
  try{
    const d = document.createElement('div');
    d.innerHTML = html || '';
    return (d.textContent || d.innerText || '').trim();
  }catch(e){
    return '';
  }
}

async function destroyEditor(ed){
  if(!ed) return;
  try{ await ed.destroy(); }catch(e){}
}

function ensureRteHost(textareaId, opts={}){
  const ta = document.getElementById(textareaId);
  if(!ta) return null;

  const hostId = textareaId + "__ck5_host";
  let host = document.getElementById(hostId);
  if(!host){
    host = document.createElement('div');
    host.id = hostId;
    host.className = 'rte-host' + (opts.small ? ' rte-small' : '');
    host.setAttribute('dir','rtl');
    host.innerHTML = ta.value || '';
    ta.insertAdjacentElement('afterend', host);
  }else{
    if(ta.value && ta.value !== host.innerHTML){
      host.innerHTML = ta.value;
    }
  }

  // hide the original textarea (we keep it synced for fallbacks and form posts)
  ta.style.display = 'none';

  if(opts.height){
    const h = (typeof opts.height === 'number') ? (opts.height + 'px') : String(opts.height);
    host.style.minHeight = h;
  }
  return {ta, host};
}

async function makeRTE(textareaId, opts={}){
  if(!window.ClassicEditor) return null;

  const parts = ensureRteHost(textareaId, {height: opts.height, small: !!opts.small});
  if(!parts) return null;
  const {ta, host} = parts;

  window.__CK5_EDITORS__ = window.__CK5_EDITORS__ || {};
  if(window.__CK5_EDITORS__[textareaId]){
    await destroyEditor(window.__CK5_EDITORS__[textareaId]);
    delete window.__CK5_EDITORS__[textareaId];
  }

  const toolbarDefault = [
    'heading','|',
    'bold','italic','|',
    'link','bulletedList','numberedList','|',
    'outdent','indent','|',
    'blockQuote','insertTable','|',
    'undo','redo'
  ];

  const toolbarMinimal = [
    'bold','italic','|',
    'link','bulletedList','numberedList','|',
    'undo','redo'
  ];

  const cfg = {
    // CKEditor 5 requires licenseKey starting from v44.0.0 (GPL usage is allowed)
    licenseKey: 'GPL',
    language: { ui: 'fa', content: 'fa' },
    toolbar: opts.toolbar || (opts.minimal ? toolbarMinimal : toolbarDefault),
    table: {
      contentToolbar: [ 'tableColumn', 'tableRow', 'mergeTableCells' ]
    }
  };

  let editor = null;
  try{
    editor = await ClassicEditor.create(host, cfg);
  }catch(e){
    console.error('CKEditor5 create failed', e);
    try{ ta.style.display = ''; host.remove(); }catch(_){ }
    return null;
  }

  // Force RTL + Persian font inside editor content
  try{
    editor.editing.view.change(writer=>{
      const root = editor.editing.view.document.getRoot();
      writer.setStyle('direction','rtl', root);
      writer.setStyle('text-align','right', root);
      writer.setStyle('font-family','Vazirmatn, Tahoma, Arial, sans-serif', root);
    });
  }catch(e){}

  const sync = ()=>{ try{ ta.value = editor.getData() || ''; }catch(e){} };
  sync();
  editor.model.document.on('change:data', sync);

  window.__CK5_EDITORS__[textareaId] = editor;
  return editor;
}

async function activateRTE(textareaId, opts={}){
  try{
    if(window.__CK5_EDITORS__ && window.__CK5_EDITORS__[textareaId]) return window.__CK5_EDITORS__[textareaId];
  }catch(e){}
  if(!window.ClassicEditor) return null;
  return await makeRTE(textareaId, opts);
}

function bindEditorChange(ed, fn){
  if(!ed) return;
  try{ ed.model.document.on('change:data', fn); }catch(e){}
}

function destroySectionEditors(){
  try{
    if(window.__CK5_EDITORS__){
      Object.keys(window.__CK5_EDITORS__).forEach(k=>{
        if(k.startsWith('secEditor_') || k.startsWith('progEditor_')){
          destroyEditor(window.__CK5_EDITORS__[k]);
          delete window.__CK5_EDITORS__[k];
        }
      });
    }
  }catch(e){}
  rteSections = {};
  rteProgramSections = {};
}

function bindLazyRTE(){
  // Intro / Conclusion
  const introTa = document.getElementById('introEditor');
  const conclTa = document.getElementById('conclusionEditor');

  function bindOne(el, which){
    if(!el) return;
    // Slightly taller editors for comfortable writing in Persian RTL
    const opts = which === 'intro' ? {height: 380} : {height: 320};
    const handler = async ()=>{
      el.removeEventListener('focus', handler);
      el.removeEventListener('click', handler);
      const ed = await activateRTE(el.id, opts);
      if(which === 'intro'){ rteIntro = ed; }
      if(which === 'conclusion'){ rteConclusion = ed; }

      if(ed){
        bindEditorChange(ed, ()=>{
          if(which === 'intro'){
            dirtyIntro = true;
            setSaveState('intro', 'در انتظار ذخیره...');
            updateWordCount('intro');
            debounceAutoSave('intro', ()=>saveIntro({silent:true}), 1300);
          }else{
            dirtyConclusion = true;
            setSaveState('conclusion', 'در انتظار ذخیره...');
            updateWordCount('conclusion');
            debounceAutoSave('conclusion', ()=>saveConclusion({silent:true}), 1300);
          }
          updateStepper();
        });
        setTimeout(()=>{ updateWordCount(which); updateStepper(); }, 0);
      }
      updateStepper();
    };
    el.addEventListener('focus', handler);
    el.addEventListener('click', handler);
  }

  bindOne(introTa, 'intro');
  bindOne(conclTa, 'conclusion');

  // Section editors (lazy init)
  document.querySelectorAll("textarea[id^='secEditor_']").forEach(el=>{
    const sid = el.id.replace("secEditor_","");
    const handler = async ()=>{
      el.removeEventListener('focus', handler);
      el.removeEventListener('click', handler);
      const ed = await activateRTE(el.id, {height: 220, small: true, minimal: true});
      rteSections[sid] = ed;
      if(ed){
        bindEditorChange(ed, ()=>{ setTimeout(()=>updateStepper(), 0); });
      }
      updateStepper();
    };
    el.addEventListener('focus', handler);
    el.addEventListener('click', handler);
  });

  // Program monitoring section editors (lazy init)
  document.querySelectorAll("textarea[id^='progEditor_']").forEach(el=>{
    const pid = el.id.replace("progEditor_", "");
    const handler = async ()=>{
      el.removeEventListener('focus', handler);
      el.removeEventListener('click', handler);
      const ed = await activateRTE(el.id, {height: 220, small: true, minimal: true});
      rteProgramSections[pid] = ed;
      if(ed){
        bindEditorChange(ed, ()=>{ setTimeout(()=>updateStepper(), 0); });
      }
      updateStepper();
    };
    el.addEventListener('focus', handler);
    el.addEventListener('click', handler);
  });
}


function getEditorHtml(which){
  const ed = which === 'intro' ? rteIntro : rteConclusion;
  return ed ? (ed.getData() || '') : (document.getElementById(which === 'intro' ? 'introEditor' : 'conclusionEditor')?.value || '');
}

function getEditorText(which){
  const ed = which === 'intro' ? rteIntro : rteConclusion;
  if(!ed){
    const ta = document.getElementById(which === 'intro' ? 'introEditor' : 'conclusionEditor');
    return ta ? (ta.value || '') : '';
  }
  return htmlToText(ed.getData());
}

async function initSectionEditors(){
  // Optional helper: force-init all section editors (not used in normal flow)
  destroySectionEditors();
  const els = Array.from(document.querySelectorAll("textarea[id^='secEditor_']"));
  for(const el of els){
    const sid = el.id.replace("secEditor_", "");
    const ed = await activateRTE(el.id, {height: 220, small: true, minimal: true});
    rteSections[sid] = ed;
    if(ed){
      bindEditorChange(ed, ()=>{ setTimeout(()=>updateStepper(), 0); });
    }
  }
}

function initSortable(){
  const container = document.getElementById("sectionsContainer");
  if(!container) return;
  if(sortable){ sortable.destroy(); sortable = null; }
  sortable = new Sortable(container, {
    animation: 150,
    handle: ".drag-handle",
    onEnd: async function(){
      // prevent leaked editor instances when the sections HTML is re-rendered
      destroySectionEditors();
      const ids = Array.from(container.querySelectorAll("[data-sid]")).map(el=>el.getAttribute("data-sid"));
      const fd = new FormData();
      fd.append("order", ids.join(","));
      const res = await fetch(`/reports/{{ report.id }}/sections/reorder`, {method:"POST", body: fd});
      const htmlOut = await res.text();
      document.getElementById("sectionsBox").innerHTML = htmlOut;
      bindLazyRTE();
      initSortable();
      updateStepper();
    }
  });
}

function updateWordCount(which){
  try{
    const el = document.getElementById(which + 'WordCount');
    if(!el) return;
    const t = getEditorText(which);
    const words = t ? t.split(/\s+/).filter(Boolean).length : 0;
    const chars = t.length;
    el.textContent = `— ${words} واژه / ${chars} کاراکتر`;
  }catch(e){}
}

function setSaveState(which, text){
  const el = document.getElementById(which + 'SaveState');
  if(el) el.textContent = text || '';
}

function debounceAutoSave(which, fn, delay=1500){
  if(autoSaveTimers[which]) clearTimeout(autoSaveTimers[which]);
  autoSaveTimers[which] = setTimeout(fn, delay);
}

function insertTemplate(target, kind){
  const ed = target === 'intro' ? rteIntro : rteConclusion;
  if(!ed) return;

  const templates = {
    standard: `<p><b>هدف گزارش</b></p><p>در این قسمت، هدف و دامنه زمانی/مکانی گزارش را توضیح دهید.</p><p><b>وضعیت کلی</b></p><p>جمع‌بندی کوتاه از وضعیت شاخص‌ها و یافته‌های مهم.</p><p><b>چالش‌ها و نکات کلیدی</b></p><ul><li>چالش/نکته شماره ۱ ...</li><li>چالش/نکته شماره ۲ ...</li></ul>`,
    minimal: `<p><b>خلاصه</b></p><ul><li>نکته ۱ ...</li><li>نکته ۲ ...</li></ul>`
  };

  const html = templates[kind] || '';
  ed.setData(html);
  if(target === 'intro') dirtyIntro = true;
  else dirtyConclusion = true;

  // counts & stepper refresh after setData
  setTimeout(()=>{
    updateWordCount(target);
    updateStepper();
  }, 0);
}

async function saveMeta(opts={silent:false}){
  const title = document.getElementById('metaTitle')?.value || '';
  const subtitle = document.getElementById('metaSubtitle')?.value || '';
  const fd = new FormData();
  fd.append('title', title);
  fd.append('subtitle', subtitle);
  setSaveState('meta', 'در حال ذخیره...');
  const res = await fetch(`/reports/{{ report.id }}/update_meta`, {method:'POST', body: fd});
  if(res.ok){
    dirtyMeta = false;
    document.getElementById('metaSaveState').textContent = 'ذخیره شد ✓';
    if(!opts.silent) showToast('عنوان ذخیره شد','success');
    updateStepper();
  }else{
    document.getElementById('metaSaveState').textContent = 'خطا در ذخیره';
    if(!opts.silent) showToast('خطا در ذخیره عنوان','danger');
  }
}

async function saveIntro(opts={silent:true}){
  const html = getEditorHtml('intro');
  const fd = new FormData();
  fd.append('note_html', html);
  setSaveState('intro', 'در حال ذخیره...');
  const res = await fetch(`/reports/{{ report.id }}/update_note`, {method:'POST', body: fd});
  if(res.ok){
    dirtyIntro = false;
    setSaveState('intro', 'ذخیره شد ✓');
    if(!opts.silent) showToast('ذخیره شد','success');
    updateStepper();
  }else{
    setSaveState('intro', 'خطا در ذخیره');
    if(!opts.silent) showToast('خطا در ذخیره','danger');
  }
}

async function saveConclusion(opts={silent:true}){
  const html = getEditorHtml('conclusion');
  const fd = new FormData();
  fd.append('conclusion_html', html);
  setSaveState('conclusion', 'در حال ذخیره...');
  const res = await fetch(`/reports/{{ report.id }}/update_conclusion`, {method:'POST', body: fd});
  if(res.ok){
    dirtyConclusion = false;
    setSaveState('conclusion', 'ذخیره شد ✓');
    if(!opts.silent) showToast('ذخیره شد','success');
    updateStepper();
  }else{
    setSaveState('conclusion', 'خطا در ذخیره');
    if(!opts.silent) showToast('خطا در ذخیره','danger');
  }
}

async function saveSectionDesc(submissionId){
  const ed = rteSections[String(submissionId)];
  const ta = document.getElementById('secEditor_' + submissionId);
  const html = ed ? (ed.getData() || '') : (ta ? (ta.value || '') : '');
  const fd = new FormData();
  fd.append('submission_id', submissionId);
  fd.append('description_html', html);
  const res = await fetch(`/reports/{{ report.id }}/sections/update`, {method:'POST', body: fd});
  const htmlOut = await res.text();
  destroySectionEditors();
  document.getElementById('sectionsBox').innerHTML = htmlOut;
  bindLazyRTE();
  initSortable();
  updateStepper();
  showToast('توضیحات ذخیره شد','success');
}

async function removeSection(submissionId){
  if(!confirm('این فرم از گزارش حذف شود؟')) return;
  const fd = new FormData();
  fd.append('submission_id', submissionId);
  const res = await fetch(`/reports/{{ report.id }}/sections/remove`, {method:'POST', body: fd});
  const htmlOut = await res.text();
  destroySectionEditors();
  document.getElementById('sectionsBox').innerHTML = htmlOut;
  bindLazyRTE();
  initSortable();
  updateStepper();
}

function adjustProgramPeriodNo(form){
  if(!form) return;
  const ptEl = form.querySelector('[name="period_type"]');
  const sel = form.querySelector('[name="period_no"]');
  const pt = ((ptEl && ptEl.value) ? ptEl.value : 'quarter').toLowerCase();
  if(!sel) return;
  const current = sel.value;
  const allowed = (pt === 'quarter') ? ['1','2','3','4'] : (pt === 'half') ? ['1','2'] : ['1'];
  sel.innerHTML = allowed.map(v=>`<option value="${v}">${v.replace('1','۱').replace('2','۲').replace('3','۳').replace('4','۴')}</option>`).join('');
  if(allowed.includes(current)) sel.value = current;
}

function validateProgramAddForm(form){
  try{
    adjustProgramPeriodNo(form);
    return true;
  }catch(e){
    return true;
  }
}

async function saveProgramSectionDesc(pid){
  const ed = rteProgramSections[String(pid)];
  const ta = document.getElementById('progEditor_' + pid);
  const html = ed ? (ed.getData() || '') : (ta ? (ta.value || '') : '');
  const fd = new FormData();
  fd.append('section_id', pid);
  fd.append('description_html', html);
  const res = await fetch(`/reports/{{ report.id }}/program_sections/update`, {method:'POST', body: fd});
  const htmlOut = await res.text();
  destroySectionEditors();
  document.getElementById('sectionsBox').innerHTML = htmlOut;
  bindLazyRTE();
  initSortable();
  updateStepper();
  showToast('توضیحات ذخیره شد','success');
}

async function removeProgramSection(pid){
  if(!confirm('این خروجی پایش برنامه از گزارش حذف شود؟')) return;
  const fd = new FormData();
  fd.append('section_id', pid);
  const res = await fetch(`/reports/{{ report.id }}/program_sections/remove`, {method:'POST', body: fd});
  const htmlOut = await res.text();
  destroySectionEditors();
  document.getElementById('sectionsBox').innerHTML = htmlOut;
  bindLazyRTE();
  initSortable();
  updateStepper();
}

async function regenerateProgramSection(pid){
  const fd = new FormData();
  fd.append('section_id', pid);
  const res = await fetch(`/reports/{{ report.id }}/program_sections/regenerate`, {method:'POST', body: fd});
  const htmlOut = await res.text();
  destroySectionEditors();
  document.getElementById('sectionsBox').innerHTML = htmlOut;
  bindLazyRTE();
  initSortable();
  updateStepper();
  showToast('بازتولید شد','success');
}

function pickUploadFile(){
  document.getElementById('reportFile')?.click();
}

async function refreshAttachmentsBox(){
  const box = document.getElementById('fileAttachmentsBox');
  if(!box) return;
  try{
    const res = await fetch(`/reports/{{ report.id }}/attachments/partial`);
    if(res.ok){
      box.innerHTML = await res.text();
    }
  }catch(e){
    // best-effort
  }
}

function setReportFileSelectedInfo(text){
  const el = document.getElementById('reportFileSelectedInfo');
  if(el) el.textContent = text;
}

async function uploadSelectedFile(fileOverride=null){
  const input = document.getElementById('reportFile');
  const file = fileOverride || (input && input.files ? input.files[0] : null);
  if(!file){ showToast('ابتدا فایل را انتخاب کنید','warning'); return; }

  setReportFileSelectedInfo(`فایل انتخاب شد: ${file.name}`);

  const btn = document.getElementById('uploadBtn');
  const sp = document.getElementById('uploadSpinner');
  const bt = document.getElementById('uploadBtnText');
  if(btn) btn.disabled = true;
  if(sp) sp.classList.remove('d-none');
  if(bt) bt.textContent = 'در حال آپلود...';

  try{
    const fd = new FormData();
    fd.append('file', file, file.name);

    const res = await fetch(`/reports/{{ report.id }}/upload`, {method:'POST', body: fd});
    const text = await res.text();

    if(!res.ok){
      // show server message if possible
      try{
        const j = JSON.parse(text);
        showToast(j.detail || j.message || 'آپلود ناموفق','danger');
      }catch(e){
        showToast(text || 'آپلود ناموفق','danger');
      }
      return;
    }

    // Refresh attachments list (server returns JSON by default; also supports HTML if changed)
    const box = document.getElementById('fileAttachmentsBox');
    if(box){
      // If response looks like HTML, render it; otherwise fetch partial.
      const looksHtml = text && (text.includes('<div') || text.includes('<h') || text.includes('list-group'));
      if(looksHtml){
        box.innerHTML = text;
      }else{
        await refreshAttachmentsBox();
      }
    }

    showToast('فایل اضافه شد','success');
    setReportFileSelectedInfo(`آپلود شد: ${file.name}`);
    if(input) input.value = '';
  }catch(e){
    showToast('آپلود ناموفق','danger');
  }finally{
    if(btn) btn.disabled = false;
    if(sp) sp.classList.add('d-none');
    if(bt) bt.textContent = 'آپلود';
  }
}

function enableDropzone(){
  const dz = document.getElementById('reportDropzone');
  const input = document.getElementById('reportFile');
  if(!dz || !input) return;

  const prevent = (e)=>{ e.preventDefault(); e.stopPropagation(); };
  ['dragenter','dragover','dragleave','drop'].forEach(evt=>{
    dz.addEventListener(evt, prevent);
  });
  dz.addEventListener('dragover', ()=>dz.classList.add('dragover'));
  dz.addEventListener('dragleave', ()=>dz.classList.remove('dragover'));
  dz.addEventListener('drop', (e)=>{
    dz.classList.remove('dragover');
    const files = e.dataTransfer?.files;
    if(files && files.length){
      setReportFileSelectedInfo(`فایل انتخاب شد: ${files[0].name}`);
      uploadSelectedFile(files[0]);
    }
  });

  dz.addEventListener('click', ()=>pickUploadFile());
  dz.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ pickUploadFile(); } });
}

function updateStepper(){
  const steps = document.querySelectorAll('#reportStepper .report-step');
  const metaTitle = (document.getElementById('metaTitle')?.value || '').trim();
  const metaSubtitle = (document.getElementById('metaSubtitle')?.value || '').trim();
  const metaDone = (metaTitle.length + metaSubtitle.length) > 0;

  const introDone = rteIntro ? (getEditorText('intro') || '').trim().length > 0 : false;
  const conclusionDone = rteConclusion ? (getEditorText('conclusion') || '').trim().length > 0 : false;
  const hasSections = (document.querySelectorAll('#sectionsContainer [data-sid]').length > 0) || (document.querySelectorAll('#programSectionsContainer [data-prog]').length > 0);

  const doneMap = {meta: metaDone, intro: introDone, sections: hasSections, conclusion: conclusionDone};
  steps.forEach(s=>{
    const key = s.getAttribute('data-step');
    if(doneMap[key]) s.classList.add('done');
    else s.classList.remove('done');
  });
}

function toggleSectionBody(sid){
  const body = document.getElementById('secBody_'+sid);
  if(!body) return;
  body.classList.toggle('d-none');
}

function toggleProgramBody(pid){
  const body = document.getElementById('progBody_'+pid);
  if(!body) return;
  body.classList.toggle('d-none');
}

function toggleAllSections(){
  sectionsCollapsed = !sectionsCollapsed;
  document.querySelectorAll('#sectionsContainer .section-body').forEach(body=>{
    if(sectionsCollapsed) body.classList.add('d-none');
    else body.classList.remove('d-none');
  });
  document.querySelectorAll('#programSectionsContainer .program-body').forEach(body=>{
    if(sectionsCollapsed) body.classList.add('d-none');
    else body.classList.remove('d-none');
  });
}

async function saveAll(){
  if(!{{ 'true' if can_edit else 'false' }}) return;
  const tasks = [];
  if(document.getElementById('metaTitle') || document.getElementById('metaSubtitle')) tasks.push(saveMeta({silent:true}));
  tasks.push(saveIntro({silent:true}));
  tasks.push(saveConclusion({silent:true}));
  try{ await Promise.all(tasks); showToast('همه بخش‌ها ذخیره شد','success'); }catch(e){ showToast('خطا در ذخیره برخی بخش‌ها','danger'); }
}

function attachAutoSave(){
  const t = document.getElementById('metaTitle');
  const s = document.getElementById('metaSubtitle');
  if(t) t.addEventListener('input', ()=>{ dirtyMeta = true; document.getElementById('metaSaveState').textContent = 'در انتظار ذخیره...'; debounceAutoSave('meta', ()=>saveMeta({silent:true}), 1400); updateStepper(); });
  if(s) s.addEventListener('input', ()=>{ dirtyMeta = true; document.getElementById('metaSaveState').textContent = 'در انتظار ذخیره...'; debounceAutoSave('meta', ()=>saveMeta({silent:true}), 1400); updateStepper(); });
}

function attachLeaveGuard(){
  window.addEventListener('beforeunload', (e)=>{
    if(dirtyIntro || dirtyConclusion || dirtyMeta){
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  setStatusBadge();
  {% if can_edit %}
    bindLazyRTE();
    initSortable();
    attachAutoSave();
    enableDropzone();
    const rf = document.getElementById('reportFile');
    if(rf){
      rf.addEventListener('change', ()=>{
        const f = rf.files && rf.files[0];
        if(f) setReportFileSelectedInfo(`فایل انتخاب شد: ${f.name}`);
        else setReportFileSelectedInfo('هیچ فایلی انتخاب نشده است.');
      });
    }
    attachLeaveGuard();
    updateStepper();
  {% endif %}

  const flowModal = document.getElementById('workflowFlowModal');
  if(flowModal){
    flowModal.addEventListener('shown.bs.modal', ()=>{
      renderWorkflowFlowDiagram();
    });
  }

  window.addEventListener('resize', ()=>{
    if(workflowFlowDiagram){
      try{
        workflowFlowDiagram.requestUpdate();
        workflowFlowDiagram.zoomToFit();
      }catch(e){}
    }
  });
});

// Re-init after HTMX swap (add section / remove etc.)
document.body.addEventListener('htmx:afterSwap', (e)=>{
  if(e.target && e.target.id === 'sectionsBox'){
    {% if can_edit %}
      destroySectionEditors();
      bindLazyRTE();
      initSortable();
      updateStepper();
    {% endif %}
  }
});
</script>

{% endblock %}
