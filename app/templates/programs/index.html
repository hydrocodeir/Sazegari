{% extends "base.html" %}

{% block content %}
<div class="container-xl py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <div class="text-muted small">مدیریت پایش برنامه</div>
      <h3 class="mb-0">تیپ فرم‌ها و برنامه پایش</h3>
    </div>
  </div>

  <div class="card p-3 border-0 shadow-sm mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-12 col-lg-5">
        <label class="form-label">سازمان</label>
        <form method="get" action="/programs" class="d-flex gap-2">
          <select class="form-select" name="org_id" onchange="this.form.submit()">
            {% for o in orgs %}
              <option value="{{ o.id }}" {% if selected_org and o.id==selected_org.id %}selected{% endif %}>{{ o.name }}</option>
            {% endfor %}
          </select>
          <noscript><button class="btn btn-outline-secondary" type="submit">اعمال</button></noscript>
        </form>
      </div>

      <div class="col-12 col-lg-7">
        <label class="form-label">ایجاد تیپ فرم جدید</label>
        <form method="post" action="/programs" class="d-flex gap-2">
          <input type="hidden" name="org_id" value="{{ selected_org.id if selected_org else '' }}" />
          <input class="form-control" name="title" placeholder="عنوان تیپ فرم" required />
          <button class="btn btn-primary" type="submit"><i class="bi bi-plus"></i></button>
        </form>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
      <div class="fw-semibold">لیست تیپ فرم‌ها ({{ selected_org.name if selected_org else '' }})</div>
      <span class="text-muted small">برای هر تیپ فرم ابتدا برنامه پایش را تکمیل کنید.</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:70px">#</th>
            <th>عنوان</th>
            <th style="width:170px">برنامه پایش</th>
            <th style="width:220px"></th>
          </tr>
        </thead>
        <tbody>
          {% for t in types %}
          {% set b = baseline_by_type.get(t.id) %}
          <tr>
            <td class="text-muted">{{ t.id }}</td>
            <td>
              <a class="text-decoration-none" href="/programs/{{ t.id }}">{{ t.title }}</a>
            </td>
            <td>
              {% if b %}
                <span class="badge text-bg-success">تکمیل/ایجاد شده</span>
              {% else %}
                <span class="badge text-bg-warning">نیاز به ایجاد</span>
              {% endif %}
            </td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="/programs/{{ t.id }}">جزئیات</a>
              <a class="btn btn-sm btn-outline-secondary" href="/programs/{{ t.id }}/baseline">برنامه پایش</a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-center text-muted py-4">تیپ فرمی ثبت نشده است.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
