<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b5ed7" />
  <title>{% block title %}سامانه سازگاری با کم‌آبی{% endblock %}</title>

  <!-- Persian font is self-hosted in /static/css/fonts -->

  <link rel="stylesheet"
        href="{{ url_for('static', path='/css/bootstrap.rtl.min.css') }}?v=local"
        onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css';">
  <link rel="stylesheet"
        href="{{ url_for('static', path='/css/bootstrap-icons.min.css') }}?v=local"
        onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css';">
  <link rel="stylesheet" href="{{ url_for('static', path='/css/app.css') }}" />
  {% block head_extra %}{% endblock %}
  <script src="{{ url_for('static', path='/js/htmx.min.js') }}?v=local"
          defer
          onerror="this.onerror=null;this.src='https://unpkg.com/htmx.org@1.9.12';"></script>
  <script src="{{ url_for('static', path='/js/bootstrap.bundle.min.js') }}?v=local"
          defer
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';"></script>
  <script src="{{ url_for('static', path='/js/app.js') }}" defer></script>
</head>

<body class="bg-body-tertiary">
  <div class="app-shell">

    <!-- Sidebar -->
    <aside class="app-sidebar">
      <div class="sidebar-brand">
        <a href="/" class="d-flex align-items-center gap-2 text-decoration-none">
          <img src="{{ url_for('static', path='/img/logo.svg') }}" alt="Logo" height="40">
        </a>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-caption">منو</div>

        <a class="sidebar-link {% if request.url.path=='/' %}active{% endif %}" href="/">
          <i class="bi bi-speedometer2"></i><span>داشبورد</span>
        </a>
        {% if user and can_submit_data(user) %}

        <a class="sidebar-link {% if request.url.path.startswith('/submissions') %}active{% endif %}" href="/submissions">
          <i class="bi bi-ui-checks-grid"></i><span>ثبت داده</span>
        </a>
        {% endif %}
        {% if user %}

        <a class="sidebar-link {% if request.url.path.startswith('/reports') %}active{% endif %}" href="/reports">
          <i class="bi bi-file-earmark-text"></i><span>گزارش‌ها</span>
        </a>
        {% endif %}

        <a class="sidebar-link {% if request.url.path.startswith('/notifications') %}active{% endif %}" href="/notifications">
          <i class="bi bi-bell"></i><span>اعلان‌ها</span>
          {% if badge_count and badge_count>0 %}
            <span class="badge text-bg-danger ms-auto">{{ badge_count }}</span>
          {% endif %}
        </a>
      </div>

      {% if user and user.role and user.role.value.startswith("secretariat") %}
      <div class="sidebar-section mt-2">
        <div class="sidebar-caption">مدیریت</div>
        {% if user and can_manage_masterdata(user) %}

        <a class="sidebar-link {% if request.url.path.startswith('/orgs') %}active{% endif %}" href="/orgs">
          <i class="bi bi-diagram-3"></i><span>ارگان‌ها</span>
        </a>
        {% endif %}
        {% if user and can_manage_masterdata(user) %}

        <a class="sidebar-link {% if request.url.path.startswith('/counties') %}active{% endif %}" href="/counties">
          <i class="bi bi-geo-alt"></i><span>شهرستان‌ها</span>
        </a>
        {% endif %}
        {% if user and can_manage_masterdata(user) %}

        <a class="sidebar-link {% if request.url.path.startswith('/org-counties') %}active{% endif %}" href="/org-counties">
          <i class="bi bi-link-45deg"></i><span>ارگان↔شهرستان</span>
        </a>
        {% endif %}
        {% if user and can_view_forms(user) %}

        <a class="sidebar-link {% if request.url.path.startswith('/forms') %}active{% endif %}" href="/forms">
          <i class="bi bi-card-checklist"></i><span>فرم‌ها</span>
        </a>
        {% endif %}
        {% if user and can_manage_masterdata(user) %}

        <a class="sidebar-link {% if request.url.path.startswith('/policy') %}active{% endif %}" href="/policy">
          <i class="bi bi-shield-lock"></i><span>Policy Matrix</span>
        </a>
        {% endif %}
        {% if user and can_manage_masterdata(user) %}

        <a class="sidebar-link {% if request.url.path.startswith('/users') %}active{% endif %}" href="/users">
          <i class="bi bi-people"></i><span>کاربران</span>
        </a>
        {% endif %}
      </div>
      {% endif %}

      <div class="sidebar-footer mt-auto">
        {% if user %}
          <div class="small text-muted mb-2">ورود با:</div>
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="text-truncate">
              <div class="fw-semibold text-truncate">{{ user.full_name or user.username }}</div>
              <div class="small text-muted text-truncate">{{ user.role_label }}</div>
            </div>
            <form method="post" action="/logout" class="m-0">
              <button type="submit" class="btn btn-sm btn-outline-danger">خروج</button>
            </form>
          </div>
        {% else %}
          <a class="btn btn-sm btn-primary w-100" href="/login">ورود</a>
        {% endif %}
      </div>
    </aside>

    <!-- Main -->
    <div class="app-main">
      <!-- Topbar -->
      <header class="app-topbar">
        <button class="btn btn-sm btn-outline-secondary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
          <i class="bi bi-list"></i>
        </button>

        <div class="topbar-title">
          {% block page_title %}سامانه سازگاری با کم‌آبی{% endblock %}
        </div>

        <div class="ms-auto d-flex align-items-center gap-2">
          <a class="btn btn-sm btn-outline-secondary position-relative" href="/notifications" title="اعلان‌ها">
            <i class="bi bi-bell"></i>
            {% if badge_count and badge_count>0 %}
              <span class="position-absolute top-0 start-0 translate-middle badge rounded-pill text-bg-danger" style="font-size:.65rem">
                {{ badge_count }}
              </span>
            {% endif %}
          </a>

          {% if user %}
            {% set disp = (user.full_name or user.username or '') %}
            {% set initials = (disp.split(' ')[0][:1] ~ (disp.split(' ')[1][:1] if disp.split(' ')|length>1 else '')) %}
            <div class="topbar-chip">
              <span class="user-avatar">{{ initials|upper }}</span>
              <div class="d-flex flex-column lh-sm">
                <span class="small fw-semibold text-truncate" style="max-width: 180px">{{ user.full_name or user.username }}</span>
                <span class="small text-muted">{{ user.role_label }}</span>
              </div>
              <form method="post" action="/logout" class="m-0 ms-2">
                <button type="submit" class="btn btn-sm btn-outline-danger">خروج</button>
              </form>
            </div>
          {% else %}
            <div class="topbar-chip">
              <i class="bi bi-person"></i>
              <span class="small">Guest</span>
              <a class="btn btn-sm btn-primary ms-2" href="/login">ورود</a>
            </div>
          {% endif %}
        </div>
      </header>

      <main class="container-fluid py-3 app-container">
        {% block content %}{% endblock %}
      </main>

      <footer class="app-footer">
        <div class="container-fluid text-muted small">
          © سامانه سازگاری با کم‌آبی
        </div>
      </footer>
    </div>
  </div>

  <!-- Mobile Sidebar (Offcanvas) -->
  <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileSidebarLabel">منو</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <a class="btn btn-outline-primary w-100 mb-2" href="/">داشبورد</a>
      <a class="btn btn-outline-primary w-100 mb-2" href="/submissions">ثبت داده</a>
      <a class="btn btn-outline-primary w-100 mb-2" href="/reports">گزارش‌ها</a>
      <a class="btn btn-outline-primary w-100 mb-2" href="/notifications">اعلان‌ها {% if badge_count and badge_count>0 %}<span class="badge text-bg-danger ms-1">{{ badge_count }}</span>{% endif %}</a>

      {% if user and user.role and user.role.value.startswith("secretariat") %}
        <hr>
        <a class="btn btn-outline-secondary w-100 mb-2" href="/orgs">ارگان‌ها</a>
        <a class="btn btn-outline-secondary w-100 mb-2" href="/counties">شهرستان‌ها</a>
        <a class="btn btn-outline-secondary w-100 mb-2" href="/org-counties">ارگان↔شهرستان</a>
        <a class="btn btn-outline-secondary w-100 mb-2" href="/forms">فرم‌ها</a>
        <a class="btn btn-outline-secondary w-100 mb-2" href="/users">کاربران</a>
      {% endif %}
    </div>
  </div>
  
  <!-- Global Loading (HTMX) -->
  <div id="globalLoading" class="global-loading">
    <div class="spinner-border text-primary" role="status" aria-label="Loading"></div>
  </div>

  <!-- Toasts -->
  <div id="toastContainer" class="toast-container position-fixed bottom-0 start-0 p-3" style="z-index: 2000;"></div>

</body>
</html>
