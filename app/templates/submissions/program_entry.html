{% extends "base.html" %}
{% block page_title %}ثبت داده دوره‌ای{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <div class="text-muted small">{{ t.title }}</div>
    <h4 class="mb-0">ثبت داده {{ period_label }}</h4>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/submissions/program"><i class="bi bi-arrow-right"></i> تغییر انتخاب</a>
    <a class="btn btn-outline-primary" href="/reports"><i class="bi bi-file-earmark-text"></i> گزارش‌ها</a>
  </div>
</div>

{% if saved %}
  <div class="alert alert-success">ذخیره شد.</div>
{% endif %}

<div class="card p-3 border-0 shadow-sm">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <div class="fw-semibold">فرم دوره‌ای</div>
      <div class="small text-muted">سال {{ year }} | نوع بازه: {{ period_type }} | شماره: {{ period_no }}</div>
    </div>
  </div>

  <form method="post" action="/submissions/program/entry">
    <input type="hidden" name="type_id" value="{{ t.id }}">
    <input type="hidden" name="year" value="{{ year }}">
    <input type="hidden" name="period_type" value="{{ period_type }}">
    <input type="hidden" name="period_no" value="{{ period_no }}">

    <div class="table-responsive">
      {% set has_targets = (entry_target_cols and entry_target_cols|length > 0) %}
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            {% for c in (entry_cols or []) %}
              <th style="min-width:140px">{{ c.label }}</th>
              {% if c.is_target %}
                <th style="width: 160px;">عملکرد {{ c.label }}</th>
              {% endif %}
            {% endfor %}

            {% if not has_targets %}
              <th style="width: 160px;">نتیجه/عملکرد این بازه</th>
            {% endif %}
            <th style="min-width:260px">اقدامات/شرح اقدامات</th>
          </tr>
        </thead>
        <tbody>
          {% for item in baseline_rows %}
            {% set br = item.row %}
            {% set data = item.data %}
            {% set targets = item.targets %}
            {% set pr = prows_map.get(br.id) %}
            {% set rmap = (prows_results_map.get(br.id) or {}) %}
            <tr>
              {% for c in (entry_cols or []) %}
                {% set key = c.key %}
                {% if c.is_target %}
                  <td class="small text-muted">{{ targets.get(key, '') }}</td>
                  <td>
                    <input name="result__{{ key }}__{{ br.id }}" class="form-control form-control-sm" placeholder="عدد" value="{{ rmap.get(key, '') }}">
                  </td>
                {% elif key == 'row_no' %}
                  <td>
                    {{ br.row_no }}
                    <input type="hidden" name="row_id" value="{{ br.id }}">
                  </td>
                {% elif key == 'title' %}
                  <td style="white-space: normal; min-width: 220px;">{{ br.title }}</td>
                {% elif key == 'unit' %}
                  <td>{{ br.unit }}</td>
                {% elif key == 'start_year' %}
                  <td>{{ br.start_year }}</td>
                {% elif key == 'end_year' %}
                  <td>{{ br.end_year }}</td>
                {% elif key == 'notes' %}
                  <td style="white-space: normal;">{{ br.notes }}</td>
                {% else %}
                  <td style="white-space: normal;">{{ data.get(key, '') }}</td>
                {% endif %}
              {% endfor %}

              {% if not has_targets %}
                <td>
                  <input name="result__single__{{ br.id }}" class="form-control form-control-sm" placeholder="عدد" value="{{ pr.result_value if pr and pr.result_value is not none else '' }}">
                </td>
              {% endif %}

              <td>
                <textarea name="actions__{{ br.id }}" class="form-control form-control-sm" rows="2" placeholder="متن اقدامات...">{{ pr.actions_text if pr else '' }}</textarea>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div></div>

    <button class="btn btn-primary" type="submit">ذخیره</button>
    <span class="text-muted small ms-2">برای درج خروجی پایش برنامه در گزارش، از بخش «گزارش‌ها» و داخل گزارش «افزودن پایش برنامه» را بزنید.</span>
  </form>
</div>

{% if history_same_type and history_same_type|length > 0 %}
  <div class="card p-3 border-0 shadow-sm mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h6 class="mb-0">سوابق همین تیپ فرم</h6>
        <div class="small text-muted">برای مشاهده/ویرایش روی بازه کلیک کنید.</div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width: 170px;">بازه</th>
            <th style="width: 140px;">عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for h in history_same_type %}
            <tr>
              <td class="small">
                {% if h.is_current %}
                  <span class="badge bg-primary">در حال ویرایش</span>
                {% endif %}
                <span class="ms-1">{{ h.period_label }}</span>
              </td>
              <td>
                <a class="btn btn-sm btn-outline-primary" href="/submissions/program/entry?type_id={{ t.id }}&year={{ h.year }}&period_type={{ h.period_type }}&period_no={{ h.period_no }}">ویرایش</a>
                <form method="post" action="/submissions/program/delete" class="d-inline" onsubmit="return confirm('این ثبت داده حذف شود؟');">
                  <input type="hidden" name="period_form_id" value="{{ h.id }}">
                  <input type="hidden" name="next_url" value="/submissions/program">
                  <button class="btn btn-sm btn-outline-danger" type="submit">حذف</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

{% endblock %}
